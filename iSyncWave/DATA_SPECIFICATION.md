# iSyncWave EEG 데이터 수신 사양

## 기본 사양

### 하드웨어 사양
- **장치**: iSyncWave EEG
- **채널 수**: 19 채널 (+ 1 Fpz Ground 채널, 데이터 미전송)
- **샘플링 레이트**: 250 Hz
- **전극 배치**: 10-20 국제 표준 시스템

### 채널 정보

**19개 EEG 채널:**
```
Fp1, Fp2, F7, F3, Fz, F4, F8, T3, C3, Cz, C4, T4, T5, P3, Pz, P4, T6, O1, O2
```

**채널 순서:**
1. Fp1 (Frontal Pole 1)
2. Fp2 (Frontal Pole 2)
3. F7 (Frontal 7)
4. F3 (Frontal 3)
5. Fz (Frontal Zero)
6. F4 (Frontal 4)
7. F8 (Frontal 8)
8. T3 (Temporal 3)
9. C3 (Central 3)
10. Cz (Central Zero)
11. C4 (Central 4)
12. T4 (Temporal 4)
13. T5 (Temporal 5)
14. P3 (Parietal 3)
15. Pz (Parietal Zero)
16. P4 (Parietal 4)
17. T6 (Temporal 6)
18. O1 (Occipital 1)
19. O2 (Occipital 2)

**참고:** Fpz는 Ground/Reference 전극으로 실제 신호 데이터로 전송되지 않음

## LSL 스트림 정보

### 스트림 메타데이터
- **Stream Name**: `iSyncWave-Android-F6EE`
- **Stream Type**: `EEG`
- **Source ID**: `isb-a-iSyncWave_F6EE`
- **Channel Count**: 19
- **Nominal Sampling Rate**: 250.0 Hz

### XML 채널 정보
- LSL 스트림은 **채널 이름을 XML로 제공하지 않음**
- 우리 시스템이 표준 10-20 이름을 매핑하여 사용

## 데이터 수신 특성

### 실제 측정 결과 (100 샘플 분석)

#### 샘플링 레이트
- **기대값**: 250 Hz (4.00 ms 간격)
- **실제 평균**: 251.9 Hz (3.97 ms 간격)
- **정확도**: 100.8% ✓

#### 수신 패턴
데이터는 **버스트(청크) 방식**으로 도착:

| 간격 범위 | 비율 | 설명 |
|----------|------|------|
| < 1 ms | 74.7% | 청크 내 샘플들 (연속 수신) |
| 1-3 ms | 7.1% | 청크 간 전환 |
| 3-5 ms | 2.0% | 정상 간격 |
| ≥ 5 ms | 16.2% | 청크 간 간격 |

**버스트 패턴 예시:**
```
청크1: [샘플1→샘플2→샘플3→샘플4] (0.2ms 간격)
        ↓ (5ms 대기)
청크2: [샘플5→샘플6→샘플7→샘플8] (0.2ms 간격)
        ↓ (5ms 대기)
청크3: [샘플9→샘플10→...] (0.2ms 간격)
```

**왜 버스트인가?**
- 네트워크 효율성을 위해 여러 샘플을 버퍼에 모아서 전송
- 실제 EEG 측정은 정확히 4ms 간격으로 이루어짐
- 전송 방식일 뿐, 데이터 정확도에는 영향 없음

### 데이터 손실

#### 20초 테스트 결과
- **예상 샘플 수**: 5,000 (250 Hz × 20초)
- **실제 수신**: 4,865 샘플
- **수신율**: 97.3%
- **손실율**: 2.7%

**손실 원인:**
- 네트워크 지연
- Python 처리 속도
- LSL 버퍼 오버플로우

**결론:** 약 3% 데이터 손실 발생, 실시간 모니터링에는 문제없는 수준

## Redis 저장 구조

### 데이터 키
- `isyncwave:eeg:stream` - Redis Stream (시계열 데이터)
- `isyncwave:eeg:meta` - Redis Hash (메타데이터)

### 데이터 포맷

각 샘플은 다음 필드를 포함:

```json
{
  "lsl_timestamp": "65677.347179",           // LSL 타임스탬프 (시스템 부팅 후 초)
  "timestamp": "1763096007.794847",          // Unix timestamp (초)
  "datetime": "2025-11-14T13:53:27.794850",  // ISO 8601 형식 현재 시간
  "Fp1": "-1694.17236328125",                // 채널 1 값
  "Fp2": "730.635009765625",                 // 채널 2 값
  "F7": "-1151.852294921875",                // 채널 3 값
  ...
  "O2": "-346.85"                            // 채널 19 값
}
```

### 타임스탬프 필드 설명

| 필드 | 타입 | 설명 | 용도 |
|------|------|------|------|
| `lsl_timestamp` | float | LSL 타임스탬프 (시스템 부팅 후 경과 시간) | 시계열 분석, 샘플 간 정확한 간격 계산 |
| `timestamp` | float | Unix timestamp (1970-01-01 기준) | 절대 시간 참조 |
| `datetime` | string | ISO 8601 형식 날짜/시간 | 사람이 읽기 쉬운 형식, Grafana 시각화 |

**중요:**
- `lsl_timestamp`는 실제 EEG 측정 시점 (가장 정확)
- `datetime`은 Python 수신 시점 (약간의 지연 포함)
- 시계열 분석에는 `lsl_timestamp` 사용 권장

### 메타데이터

`isyncwave:eeg:meta` 키에 저장되는 정보:

```json
{
  "stream_name": "iSyncWave-Android-F6EE",
  "stream_type": "EEG",
  "channel_count": "19",
  "sampling_rate": "250.0",
  "channels": "Fp1,Fp2,F7,F3,Fz,F4,F8,T3,C3,Cz,C4,T4,T5,P3,Pz,P4,T6,O1,O2",
  "start_time": "2025-11-14T13:53:07.789456",
  "end_time": "2025-11-14T13:53:27.794850",
  "total_samples": "4865",
  "duration_seconds": "20.00"
}
```

## 데이터 값 범위

### 전형적인 EEG 신호 범위
- **단위**: μV (마이크로볼트)
- **관찰된 범위**: 약 -2000 ~ +2000
- **정상 EEG**: 일반적으로 ±100 μV 내외

**예시 값:**
```
Fp1: -1694.17 μV
Fp2: 730.64 μV
F7: -1151.85 μV
C3: 1500.60 μV
```

## 성능 통계

### Python 수신 성능

#### 실시간 처리 속도
- **평균 수신율**: 243 Hz (97.3%)
- **최대 순간 수신율**: ~248 Hz
- **Redis 저장 성공률**: 100% (수신된 샘플 모두 저장)

#### CPU/메모리 사용량
- **Python 프로세스**: 약 13% CPU (단일 코어)
- **메모리**: 약 50 MB

### Redis 성능

#### 저장 속도
- **XADD 명령 속도**: 250+ ops/sec
- **지연 시간**: < 1ms per sample

#### 메모리 사용량 (샘플당)
- **단일 샘플 크기**: 약 1-2 KB (19 채널 + 메타데이터)
- **10,000 샘플**: 약 10-20 MB
- **50,000 샘플**: 약 50-100 MB

**권장 maxlen 설정:**
- 실시간 모니터링: `--redis-maxlen 5000` (20초분)
- 단기 분석: `--redis-maxlen 25000` (100초분)
- 중기 분석: `--redis-maxlen 75000` (5분분)
- 무제한 저장: maxlen 미지정 (CSV 백업 권장)

## 네트워크 요구사항

### 대역폭
- **단일 샘플 크기**: 약 76 bytes (19 channels × 4 bytes)
- **초당 전송량**: 250 samples/sec × 76 bytes ≈ **19 KB/s**
- **권장 네트워크**: 100 Mbps 이상

### 지연 시간
- **LSL 멀티캐스트**: 일반적으로 < 10ms
- **로컬 네트워크 (Wi-Fi)**: < 50ms
- **Python 처리**: < 5ms

### 연결 안정성
- **Wi-Fi 신호 강도**: -50 dBm 이상 권장
- **패킷 손실**: < 1% 권장
- **동일 서브넷 필수**: 192.168.0.x

## 데이터 품질 검증

### 정상 동작 확인 체크리스트

✅ **스트림 연결**
- [ ] LSL 스트림 발견됨
- [ ] 채널 수 = 19
- [ ] 샘플링 레이트 = 250 Hz

✅ **데이터 수신**
- [ ] 평균 수신율 > 240 Hz (96%)
- [ ] Redis 저장 성공
- [ ] datetime이 현재 시간과 일치

✅ **데이터 품질**
- [ ] 채널 값이 실시간으로 변화
- [ ] 값 범위가 합리적 (±2000 이내)
- [ ] 샘플 간격 평균 ≈ 4ms

### 문제 해결

**수신율이 낮을 때 (< 240 Hz):**
1. Wi-Fi 신호 강도 확인
2. 네트워크 트래픽 확인
3. CPU 사용률 확인
4. Redis 성능 확인

**datetime이 과거 시간일 때:**
- `lsl_to_redis.py` 업데이트 필요
- `datetime.now()` 사용 확인

**데이터가 안 변할 때:**
1. 태블릿 앱 EEG 신호 확인
2. LSL 스트리밍 활성화 확인
3. 장치 전원 및 전극 연결 확인

## 참고 자료

### LSL 프로토콜
- LSL 버전: 1.16.2
- 프로토콜: UDP 멀티캐스트
- Python 라이브러리: pylsl

### Redis
- 버전: 6.x
- 데이터 타입: Stream, Hash
- 인코딩: UTF-8

### Python 환경
- Python: 3.8.10
- 플랫폼: Linux ARM64 (aarch64)
- 필수 패키지: pylsl, redis

### 생성 일시
- 작성: 2025-11-14
- 기반 데이터: 실제 측정 및 분석
